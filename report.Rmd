---
title: "report"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = "#>", 
                      warning = FALSE, message = FALSE,
                      dpi = 600)
pacman::p_load(googlesheets, MASS, tidyverse, janitor, filesstrings,
               quantmod, lubridate, magrittr, clipr, knitr)

ensure_time_hm <- function(x) {
  if (!is.difftime(x)) x %<>% hm()
  x
}

ensure_date_dmy <- function(x) {
  if (!is.Date(x)) x %<>% dmy()
  x
}

evaluate_frac <- function(x) {
  map_dbl(x, ~ eval(parse(text = .)))
}

get_week <- function(date_vec) {
  date_vec %>% 
    as.numeric() %>% 
    {((. - min(.)) %/% 7) + 1}
}

get_exchange_rate <- function(from, to, dt = Sys.Date()) {
  obj.names <- getFX(paste0(from, "/", to), from = dt - 1, to = dt)
  result <- numeric(length(obj.names))
  names(result) <- obj.names
  for (obj.name in obj.names) {
    result[obj.name] <- as.numeric(get(obj.name))[1]
    # Clean up    
    rm(obj.name)
  }
  return(result)
}

exrate_gbp_eur <- get_exchange_rate("GBP", "EUR")

### Get the spreadsheet
df <- "Sys Syndo" %>%
  gs_title() %>%
  gs_read("Master Sheet") %>%
  clean_names() %>% 
  filter(!is.na(date), !is.na(profit_at_time_pts)) %>% 
  mutate(date = ensure_date_dmy(date), time = ensure_time_hm(time)) %>% 
  arrange(date, time, course, horse)
```

# Profit over time

```{r profit-over-time}
plot_df <- df %>% 
  mutate(week = get_week(date)) %>% 
  group_by(week) %>% 
  summarise(pat = median(profit_at_time_pts)) 
ggplot(plot_df, aes(x = week, y = pat)) + 
  geom_hline(yintercept = 0, colour = "red") + geom_line() + 
  ylab("profit at time (pts)") + ggtitle("profit over time")
```

```{r profit-over-time-smooth}
ggplot(plot_df, aes(x = week, y = pat)) + 
  geom_hline(yintercept = 0, colour = "red") + geom_smooth(se = FALSE) + 
  ylab("profit at time (pts)") + ggtitle("smoothed profit over time")
```


# ROI and ROC

```{r end-profit, include=FALSE}
profit_df <- df %>% 
  filter(!is.na(date)) %>% 
  mutate(profit_gbp = as.numeric(str_replace_all(profit_2, "£", "")), 
         profit_eur = as.numeric(str_replace_all(profit, "€", "")))
profit_eur <- sum(as.numeric(profit_df$profit_eur)) + 
  sum(as.numeric(profit_df$profit_gbp)) * exrate_gbp_eur
profit_eur %<>% round()
total_fee_eur <- 3 * 600 * exrate_gbp_eur
total_fee_eur %<>% round()
point_eur_mean <- mean(profit_df$pt)
wagered_total_eur <- profit_df %>% 
  mutate(w_t = if_else(is.na(places), stake_line_pts,
                       2 * stake_line_pts)) %>% 
  pull(w_t) %>% 
  sum() %>% 
  c(point_eur_mean) %>% 
  prod() %>% 
  round()
total_investment_eur <- 9000
```

We put in €`r total_investment_eur` and we've made a profit of €`r format(profit_eur, sci = FALSE, big.mark = ",")` on the bets. However, we've paid three subscriptions of £600 which amounts to €`r format(total_fee_eur, sci = FALSE, big.mark = ",")` so our net profit is €`r format(profit_eur - total_fee_eur, sci = FALSE, big.mark = ",")`. That's a return on capital of `r round(100 * (profit_eur - total_fee_eur) / total_investment_eur, 2)`%. This gives us a current bank of €`r format(round(total_investment_eur - total_fee_eur + profit_eur), sci = FALSE)`.

We have wagered a total of €`r format(wagered_total_eur, big.mark = ",")` and made a betting profit of €`r format(profit_eur, sci = FALSE, big.mark = ",")`, which gives us a betting ROI of `r round(100 * profit_eur / wagered_total_eur, 2)`%.


# Have any bookies been riddled?

```{r bookies}
nas_to_zero <- function(x) {
  x[is.na(x)] <- 0
  x
}

pos_to_plus <- function(x) {
  pos <- x > 0
  prefix <- if_else(pos, "+", "")
  str_c(prefix, x)
}

df %>% 
  group_by(placer, bookmaker) %>% 
  summarise(profit_pts = sum(profit_pts)) %>% 
  ungroup() %>% 
  spread(placer, profit_pts) %>%
  mutate_if(is.numeric, nas_to_zero) %>%
  mutate(total = Aidan + Rory) %>% 
  arrange(desc(total)) %>% 
  mutate_if(is.numeric, round) %>% 
  mutate_if(is.numeric, pos_to_plus) %>% 
  kable(caption = "bookie profits (pts)")
```


# Minimum acceptable odds

```{r min-acceptable-odds}
winnings_sum <- df$profit_pts %>% {sum(.[. > 0])} %>% round()
losses_sum <- df$profit_pts %>% {-sum(.[. < 0])} %>% round()
profit_factor <- losses_sum / winnings_sum
```

We've had winnings of `r winnings_sum` points and losses of `r losses_sum` points, so even if our odds were only a fraction `r losses_sum` / `r winnings_sum` = `r round(losses_sum / winnings_sum, 2)` of what we actually got, we'd still be breaking even.


# Winners and losers

Here's a count of the number of winners, losers, and places we've had.

```{r winners-losers-count}
df_win_lose <- df %>% 
  mutate(ewres = paste(if_else(is.na(places), "Win only", "Each way"),
                       result)) %>% 
  pull(ewres) %>% {
    .[!str_detect(., "NR")]
  } %>% 
  tabyl() %T>% 
  {names(.)[1] <- "result"} %>% 
  arrange(desc(n)) %>% 
  mutate(percent = str_c(round(percent * 100), "%"))
kable(df_win_lose)
```


# Win only vs each way

```{r win-ew}
win_total_eur <- profit_df %>% 
  filter(is.na(places)) %>% 
  mutate(prof_eur = profit_eur + profit_gbp * exrate_gbp_eur) %>% 
  pull(prof_eur) %>% 
  sum() %>% 
  round()
ew_total_eur <- profit_df %>% 
  filter(!is.na(places)) %>% 
  mutate(prof_eur = profit_eur + profit_gbp * exrate_gbp_eur) %>% 
  pull(prof_eur) %>% 
  sum() %>% 
  round()
non_dup_bets <- filter(df, !duplicated(paste(date, horse)))
n_win_bets <- sum(is.na(non_dup_bets$places))
n_ew_bets <- sum(!is.na(non_dup_bets$places))
```

* We've made `r n_win_bets` _win only_ bets, on which we've made a profit of €`r format(win_total_eur, big.mark = ",")`. 
* We've made `r n_ew_bets` _each way_ bets, on which we've made a profit of €`r format(ew_total_eur, big.mark = ",")`.